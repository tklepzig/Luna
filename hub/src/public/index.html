<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="theme-color" content="black">
    <meta name="viewport" content="user-scalable=yes, initial-scale=1.0, maximum-scale=10.0, width=device-width" />
    <base href="/">
    <title>Luna</title>
    <link rel="manifest" href="manifest.json">
    <style media="screen">
        #main.fullscreen,
        #mouse.fullscreen {
            width: 100%;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <div>
        <button id="enterFullscreen">Enter Fullscreen</button>
        <button id="enableMouse">Enable Mouse</button>
    </div>
    <div id="main">
        <button data-key="P">Previous</button>
        <div class="id"></div>
        <button data-key="N">Next</button>
        <button data-key="F4" data-modifiers="win">Toggle Mute</buttonbutton>
    </div>
    <div id="mouse"></div>
    <script>
        var downEvent;
        var moveEvent;
        var upEvent;
        var getMousePosition;
        var getTouchCount;

        if ("ontouchstart" in window) {
            downEvent = "touchstart";
            moveEvent = "touchmove";
            upEvent = "touchend";

            getMousePosition = function (e) {
                return { x: e.originalEvent.targetTouches[0].pageX, y: e.originalEvent.targetTouches[0].pageY };
            };
            getTouchCount = function (e) {
                return e.originalEvent.touches.length;
            }

        } else if ("pointerdown" in window) {
            downEvent = "pointerdown";
            moveEvent = "pointermove";
            upEvent = "pointerup";

            getMousePosition = function (e) {
                return { x: e.pageX, y: e.pageY };
            };
            getTouchCount = function () {
                return 1;
            }
        } else {
            downEvent = "mousedown";
            moveEvent = "mousemove";
            upEvent = "mouseup";

            getMousePosition = function (e) {
                return { x: e.pageX, y: e.pageY };
            };
            getTouchCount = function () {
                return 1;
            }
        }

        $(document).on(upEvent, ".button[data-key]", function () {
            executeSocketCommand(function (e) {
                socket.emit('keyboard-pressKey', id, e.key, e.modifiers);
            }, { key: $(this).data('key'), modifiers: $(this).data("modifiers") });
        });

        $("#enableMouse").on(upEvent, function () {
            $("#mouse").removeClass('hidden');
            fullscreen.toggle($("#mouse").get(0));
            $("#mouse").toggleClass('fullscreen');
        });

        $("#enterFullscreen").on(upEvent, function () {
            fullscreen.toggle($("#main").get(0));
            $("#main").toggleClass('fullscreen');
        });
    </script>
    <script>
        (function () {
            var clickPoint = null;
            var downPoint = null;
            var touchCount = null;
            var firstMove;

            $("#mouse").on(downEvent, function (e) {
                touchCount = getTouchCount(e);
                var pos = getMousePosition(e);
                downPoint = clickPoint = {
                    x: pos.x,
                    y: pos.y
                };
                firstMove = true;

                e.stopPropagation();
                e.preventDefault();
                return false;
            });

            $("#mouse").on(moveEvent, function (e) {
                if (downPoint == null)
                    return true;

                var pos = getMousePosition(e);

                var offset = {
                    x: parseInt(pos.x - downPoint.x),
                    y: parseInt(pos.y - downPoint.y)
                };

                if (firstMove) {
                    offset.x = offset.x < 0
                        ? -1
                        : 1;
                    offset.y = offset.y < 0
                        ? -1
                        : 1;
                    firstMove = false;
                }

                downPoint = {
                    x: pos.x,
                    y: pos.y
                };

                switch (touchCount) {
                    case 1:

                        if (Math.abs(offset.x) > 2)
                            offset.x *= (offset.x.toString().length + 2);
                        if (Math.abs(offset.y) > 2)
                            offset.y *= (offset.y.toString().length + 2);

                        socket.emit('mouse-move', id, offset);

                        break;
                    case 2:
                        var delta;
                        if (Math.abs(offset.x) > 4) {
                            delta = Math.floor(Math.abs(offset.x) / 2) * 60;
                            if (offset.x > 0)
                                delta *= -1;

                            socket.emit('mouse-hWheel', id, delta);
                        } else {
                            delta = Math.floor(Math.abs(offset.y) / 2) * 60;
                            if (offset.y > 0)
                                delta *= -1;

                            socket.emit('mouse-wheel', id, delta);
                        }

                        break;
                }

                e.stopPropagation();
                e.preventDefault();
                return false;
            });

            $("#mouse").on(upEvent, function (e) {
                if (clickPoint != null && Math.abs(clickPoint.x - downPoint.x) < 2 && Math.abs(clickPoint.y - downPoint.y) < 2) {
                    switch (touchCount) {
                        case 1:
                            socket.emit('mouse-leftClick', id);
                            break;
                        case 2:
                            socket.emit('mouse-rightClick', id);
                            break;
                        case 3:
                            socket.emit('mouse-middleClick', id);
                            break;
                    }
                }

                downPoint = null;

                e.stopPropagation();
                e.preventDefault();
                return false;
            });
        })();
    </script>
</body>

</html>